<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stash</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<!-- SUPABASE -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* =========================================================
   VARIABLES
========================================================= */
:root {
  --bg:#f4f6f8;
  --panel:#ffffff;
  --surface:#f9fafb;
  --accent:#3b82f6;
  --accent-soft:#eef2ff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --radius:18px;
  --shadow:0 8px 24px rgba(0,0,0,.06);
}

/* =========================================================
   RESET
========================================================= */
* { box-sizing:border-box; font-family:Inter,system-ui }
body { margin:0; background:var(--bg); color:var(--text) }

/* =========================================================
   LAYOUT
========================================================= */
.app {
  display:grid;
  grid-template-columns:240px 1fr 360px;
  height:100vh;
}

.sidebar {
  background:var(--panel);
  padding:20px;
  border-right:1px solid var(--border);
}

.main {
  padding:24px;
  overflow:auto;
}

.detail {
  background:var(--panel);
  padding:20px;
  border-left:1px solid var(--border);
  display:none;
  overflow:auto;
}

/* =========================================================
   SIDEBAR
========================================================= */
.sidebar h2 {
  margin:0 0 20px;
}

.folder {
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  color:var(--muted);
  margin-bottom:6px;
}

.folder.active {
  background:var(--accent-soft);
  color:var(--text);
}

.new-folder {
  margin-top:14px;
  padding:10px;
  border-radius:12px;
  border:1px dashed var(--border);
  background:none;
  cursor:pointer;
  width:100%;
}

/* =========================================================
   HEADER
========================================================= */
.top {
  display:flex;
  justify-content:flex-end;
  margin-bottom:20px;
}

.top button {
  padding:10px 18px;
  border-radius:999px;
  border:none;
  background:var(--accent);
  color:white;
  cursor:pointer;
}

/* =========================================================
   LIST / CARDS
========================================================= */
.list {
  display:flex;
  flex-direction:column;
  gap:14px;
}

.card {
  background:var(--panel);
  padding:16px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
}

.card.pinned {
  background:var(--accent-soft);
  border-left:4px solid var(--accent);
}

.card small {
  color:var(--muted);
}

.card-actions {
  display:flex;
  gap:8px;
  margin-top:10px;
}

.card-actions button {
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--surface);
  cursor:pointer;
}

/* =========================================================
   INLINE INFO
========================================================= */
.info {
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid var(--border);
  display:none;
  font-size:.85rem;
}

/* =========================================================
   DETAIL PANEL
========================================================= */
.detail h3 { margin-top:0 }
.detail img {
  width:100%;
  border-radius:12px;
  margin-top:10px;
}

/* =========================================================
   MODALS
========================================================= */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-box {
  width:420px;
  background:var(--panel);
  padding:20px;
  border-radius:20px;
}

.modal-box h3 { margin-top:0 }

.modal-box label {
  display:block;
  margin-top:12px;
  font-size:.8rem;
  color:var(--muted);
}

.modal-box input,
.modal-box textarea,
.modal-box select {
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
}

.actions {
  display:flex;
  gap:10px;
  margin-top:18px;
}

.actions button {
  flex:1;
  padding:10px;
  border-radius:12px;
  border:none;
  cursor:pointer;
}

.actions button:first-child {
  background:var(--accent);
  color:white;
}

.actions button:last-child {
  background:var(--surface);
  border:1px solid var(--border);
}

/* =========================================================
   EMPTY STATE
========================================================= */
.empty {
  color:var(--muted);
  padding:40px;
  text-align:center;
}
</style>
</head>

<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Stash</h2>
    <div id="folders"></div>
    <button class="new-folder" onclick="openFolderModal()">+ New folder</button>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="top">
      <button onclick="openItemModal()">Add item</button>
    </div>
    <div class="list" id="list"></div>
  </main>

  <!-- DETAIL PANEL -->
  <aside class="detail" id="detail"></aside>

</div>

<!-- FOLDER MODAL -->
<div class="modal" id="folderModal">
  <div class="modal-box">
    <h3>New folder</h3>
    <input id="folderName" placeholder="Folder name">
    <div class="actions">
      <button onclick="createFolder()">Create</button>
      <button onclick="closeFolderModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- ITEM MODAL -->
<div class="modal" id="itemModal">
  <div class="modal-box">
    <h3>Add item</h3>

    <label>Name</label>
    <input id="itemName">

    <label>Identifier</label>
    <input id="itemIdentifier">

    <label>Folder (required)</label>
    <select id="itemFolder"></select>

    <label>Notes</label>
    <textarea id="itemNotes"></textarea>

    <label>Screenshots (optional)</label>
    <input type="file" id="itemImages" multiple>

    <label>
      <input type="checkbox" id="itemPinned"> Pin / notify
    </label>

    <div class="actions">
      <button onclick="saveItem()">Save</button>
      <button onclick="closeItemModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   SUPABASE
========================================================= */
const supabase = supabaseJs.createClient(
  "https://cagvxdkcqqqfevwwcbaa.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhZ3Z4ZGtjcXFxZmV2d3djYmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NjE4NzAsImV4cCI6MjA4MzAzNzg3MH0.ExUdxfTMpNXc8-yW1NVcqv4P5Vy9PbKjGJSAQDcA-rk"
);

/* =========================================================
   STATE
========================================================= */
let state = {
  folders: [],
  items: [],
  activeFolder: null
};

/* =========================================================
   INIT
========================================================= */
init();
async function init(){
  await loadFolders();
  await loadItems();
}

/* =========================================================
   LOADERS
========================================================= */
async function loadFolders(){
  const { data } = await supabase
    .from("folders")
    .select("*")
    .order("created_at");
  state.folders = data || [];
  if (!state.activeFolder && state.folders[0])
    state.activeFolder = state.folders[0].id;
  renderFolders();
}

async function loadItems(){
  const { data } = await supabase
    .from("accounts")
    .select("*");
  state.items = data || [];
  renderItems();
}

/* =========================================================
   RENDER
========================================================= */
function renderFolders(){
  folders.innerHTML="";
  itemFolder.innerHTML="";

  state.folders.forEach(f=>{
    const d=document.createElement("div");
    d.className="folder"+(f.id===state.activeFolder?" active":"");
    d.textContent=f.name;
    d.onclick=()=>{
      state.activeFolder=f.id;
      renderFolders();
      renderItems();
    };
    folders.appendChild(d);

    const o=document.createElement("option");
    o.value=f.id;
    o.textContent=f.name;
    itemFolder.appendChild(o);
  });
}

function renderItems(){
  list.innerHTML="";
  detail.style.display="none";

  const filtered=state.items
    .filter(i=>i.folder_id===state.activeFolder)
    .sort((a,b)=>b.pinned-a.pinned);

  if(filtered.length===0){
    list.innerHTML=`<div class="empty">No items in this folder.</div>`;
    return;
  }

  filtered.forEach(i=>{
    const c=document.createElement("div");
    c.className="card"+(i.pinned?" pinned":"");

    c.innerHTML=`
      <strong>${i.name}</strong><br>
      <small>${i.identifier}</small>

      <div class="info">${i.notes||"No notes"}</div>

      <div class="card-actions">
        <button onclick="event.stopPropagation();toggleInfo(this)">Info</button>
        <button onclick="event.stopPropagation();openDetail('${i.id}')">View</button>
      </div>
    `;
    list.appendChild(c);
  });
}

/* =========================================================
   INTERACTION
========================================================= */
function toggleInfo(btn){
  const info=btn.closest(".card").querySelector(".info");
  info.style.display=info.style.display==="block"?"none":"block";
}

async function openDetail(id){
  const item=state.items.find(i=>i.id===id);
  if(!item) return;

  if(item.pinned){
    await supabase.from("accounts")
      .update({pinned:false})
      .eq("id",id);
  }

  const { data:shots } = await supabase
    .from("screenshots")
    .select("*")
    .eq("account_id",id);

  detail.style.display="block";
  detail.innerHTML=`
    <h3>${item.name}</h3>
    <p><b>Identifier:</b> ${item.identifier}</p>
    <p>${item.notes||""}</p>
    <h4>Screenshots</h4>
    ${shots && shots.length
      ? shots.map(s=>`<img src="${s.url}">`).join("")
      : "<p style='color:#6b7280'>None</p>"
    }
  `;

  await loadItems();
}

/* =========================================================
   MODALS
========================================================= */
function openFolderModal(){folderModal.style.display="flex"}
function closeFolderModal(){folderModal.style.display="none"}
function openItemModal(){itemModal.style.display="flex"}
function closeItemModal(){itemModal.style.display="none"}

/* =========================================================
   CREATE
========================================================= */
async function createFolder(){
  if(!folderName.value.trim()) return;
  await supabase.from("folders").insert({name:folderName.value});
  folderName.value="";
  closeFolderModal();
  loadFolders();
}

async function saveItem(){
  if(!itemFolder.value){
    alert("Folder required");
    return;
  }

  const { data:inserted } = await supabase
    .from("accounts")
    .insert({
      name:itemName.value,
      identifier:itemIdentifier.value,
      notes:itemNotes.value,
      folder_id:itemFolder.value,
      pinned:itemPinned.checked
    })
    .select()
    .single();

  const files=itemImages.files;
  for(const file of files){
    const path=`${inserted.id}/${Date.now()}_${file.name}`;
    const { error } = await supabase
      .storage.from("screenshots")
      .upload(path,file);

    if(!error){
      const { data } = supabase
        .storage.from("screenshots")
        .getPublicUrl(path);

      await supabase.from("screenshots")
        .insert({account_id:inserted.id,url:data.publicUrl});
    }
  }

  itemName.value="";
  itemIdentifier.value="";
  itemNotes.value="";
  itemImages.value="";
  itemPinned.checked=false;

  closeItemModal();
  loadItems();
}
</script>

</body>
</html>
